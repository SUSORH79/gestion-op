<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gestión Producción – OP</title>

<meta name="theme-color" content="#1a73e8" />
<link rel="manifest" href="manifest.webmanifest" />

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background:#f2f2f2;
  }
  header {
    background:#1a73e8;
    color:white;
    padding:12px;
    font-size:18px;
    text-align:center;
  }
  .container {
    padding:10px;
    max-width:600px;
    margin:0 auto;
  }
  .op-card {
    background:white;
    padding:10px 12px;
    margin-bottom:8px;
    border-radius:8px;
    box-shadow:0 1px 3px rgba(0,0,0,0.1);
  }
  .btn {
    background:#1a73e8;
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
  }
  .btn:active {
    transform: scale(0.97);
  }
  .btn-secondary {
    background:#6c757d;
  }
  .btn-danger {
    background:#dc3545;
  }
  .btn-success {
    background:#28a745;
  }
  .btn-small {
    padding:4px 8px;
    font-size:12px;
  }
  #scannerSim {
    margin-top:12px;
    background:white;
    padding:10px;
    border-radius:8px;
  }
  .tag-seccion {
    background:#e0e0e0;
    padding:2px 6px;
    border-radius:4px;
    font-size:11px;
    margin-top:4px;
    display:inline-block;
  }
  .filters {
    background:white;
    padding:8px;
    border-radius:8px;
    margin-bottom:10px;
    box-shadow:0 1px 3px rgba(0,0,0,0.08);
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .filters select,
  .filters input {
    padding:6px;
    border-radius:4px;
    border:1px solid #ccc;
    font-size:13px;
    flex:1 1 45%;
    box-sizing:border-box;
  }
  .filters button {
    flex:1 1 100%;
  }
  .section-title {
    margin-top:10px;
    margin-bottom:4px;
    font-weight:bold;
    font-size:14px;
    color:#555;
  }
  .historial-list {
    margin-top:6px;
    font-size:11px;
    color:#444;
  }
  .historial-list li {
    margin-bottom:3px;
  }
  .due-badge {
    padding:2px 6px;
    border-radius:4px;
    font-size:11px;
    margin-left:6px;
  }
  .due-red {
    background:#e53935;
    color:white;
  }
  .due-orange {
    background:#fb8c00;
    color:white;
  }
  input, select {
    box-sizing:border-box;
  }
  #cameraArea video {
    width:100%;
    border-radius:8px;
    background:black;
  }
</style>

<!-- Librería de lectura de códigos de barras (ZXing) -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
</head>

<body>
<header>Gestión OP producción</header>

<div class="container">

  <!-- Filtros -->
  <div class="filters">
    <select id="filtroSeccion" onchange="renderOrdenes()">
      <option value="Todas">Todas las secciones</option>
      <option value="Corte">Corte</option>
      <option value="Pantógrafos">Pantógrafos</option>
      <option value="Bancos">Bancos</option>
      <option value="Barnizado">Barnizado</option>
      <option value="Montaje">Montaje</option>
      <option value="Archivo">Archivo</option>
    </select>

    <input id="filtroOP" placeholder="Filtrar por OP" oninput="renderOrdenes()" />
    <input id="filtroCliente" placeholder="Filtrar por cliente" oninput="renderOrdenes()" />

    <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar filtros</button>
  </div>

  <!-- Lista de órdenes -->
  <h3 style="margin:8px 0;">Órdenes de producción</h3>
  <div id="opList"></div>

  <!-- Escaneo / entrada código -->
  <div style="margin-top:12px; margin-bottom:8px; display:flex; gap:6px;">
    <button class="btn" style="flex:1;" onclick="abrirScannerManual()">Introducir código</button>
    <button class="btn btn-success" style="flex:1;" onclick="abrirScannerCamara()">Cámara</button>
  </div>

  <!-- Panel de escaneo / edición -->
  <div id="scannerSim" style="display:none;">
    <h3 style="margin-top:0;">Escanear / abrir OP</h3>
    <p style="margin:4px 0;">Código de OP (manual o escaneado):</p>

    <input id="codigoInput" placeholder="Ej: 2505823"
           style="padding:8px; width:100%; margin-bottom:6px;" />
    <button class="btn" style="margin-bottom:8px;" onclick="simularEscaneo()">Cargar OP</button>

    <!-- Zona cámara -->
    <div id="cameraArea" style="display:none; margin-top:8px;">
      <video id="videoPreview" autoplay muted playsinline></video>
      <button class="btn btn-secondary" style="margin-top:6px;" type="button" onclick="pararCamara()">
        Cerrar cámara
      </button>
    </div>

    <p id="resultado" style="margin-top:4px; font-weight:bold;"></p>

    <!-- Editor -->
    <div id="editorOP"
         style="margin-top:10px; display:none; background:#fafafa; padding:8px; border-radius:8px; border:1px solid #ddd;">

      <p style="margin:4px 0;"><strong>OP actual:</strong> <span id="opCodigo"></span></p>

      <label style="font-size:13px;">Cliente (opcional):</label>
      <input id="clienteInput" style="padding:8px; width:100%; margin-bottom:6px;" />

      <label style="font-size:13px;">Mueble / descripción:</label>
      <input id="muebleInput" style="padding:8px; width:100%; margin-bottom:6px;" />

      <label style="font-size:13px;">Sección:</label>
      <select id="seccionSelect" style="padding:8px; width:100%; margin-bottom:6px;">
        <option value="Corte">Corte</option>
        <option value="Pantógrafos">Pantógrafos</option>
        <option value="Bancos">Bancos</option>
        <option value="Barnizado">Barnizado</option>
        <option value="Montaje">Montaje</option>
        <option value="Archivo">Archivo</option>
      </select>

      <label style="font-size:13px;">Fecha de entrega (obligatoria):</label>
      <input type="date" id="fechaEntrega" style="padding:8px; width:100%; margin-bottom:6px;" />

      <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
        <button class="btn" style="flex:1;" onclick="guardarOP()">Guardar</button>
        <button class="btn btn-secondary" style="flex:1;" type="button" onclick="toggleHistorial()">Historial</button>
        <button class="btn btn-danger" style="flex:1;" type="button" onclick="eliminarOP()">Eliminar</button>
      </div>

      <ul id="historialOP" class="historial-list" style="display:none;"></ul>
      <p id="movimientoResultado" style="margin-top:6px; font-weight:bold;"></p>
    </div>
  </div>
</div>

<script>
/* ===== PERSISTENCIA LOCAL (OFFLINE) ===== */
const STORAGE_KEY = 'op_app_ordenes_v1';
let ordenes = [];
let opActual = null;

/* ZXing lector */
let codeReader = null;

function loadOrdenes() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (Array.isArray(data)) ordenes = data;
  } catch (e) {
    console.error('Error cargando ordenes', e);
  }
}

function saveOrdenes() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(ordenes));
  } catch (e) {
    console.error('Error guardando ordenes', e);
  }
}

/* ===== FILTROS ===== */
function limpiarFiltros() {
  document.getElementById('filtroSeccion').value  = 'Todas';
  document.getElementById('filtroOP').value       = '';
  document.getElementById('filtroCliente').value  = '';
  renderOrdenes();
}

/* Limpieza automática de OP en Archivo con más de 15 días desde fecha entrega */
function limpiarAntiguas() {
  const ahora = new Date();
  const DIA   = 24 * 60 * 60 * 1000;
  const paraBorrar = [];

  ordenes.forEach(op => {
    if (op.seccion !== 'Archivo') return;
    if (!op.fechaEntrega) return;
    const f = new Date(op.fechaEntrega + 'T00:00:00');
    if (isNaN(f)) return;
    const diffDias = (ahora - f) / DIA;
    if (diffDias >= 15) {
      paraBorrar.push(op.codigo);
    }
  });

  if (paraBorrar.length > 0) {
    const msg = `Hay ${paraBorrar.length} OP en ARCHIVO con fecha de entrega de hace más de 15 días.\n\n¿Quieres borrarlas definitivamente?`;
    if (confirm(msg)) {
      ordenes = ordenes.filter(o => !paraBorrar.includes(o.codigo));
      saveOrdenes();
    }
  }
}

/* ===== RENDER TABLERO ===== */
function renderOrdenes() {
  limpiarAntiguas();

  const cont = document.getElementById('opList');
  if (!cont) return;
  cont.innerHTML = '';

  const filtroSec     = document.getElementById('filtroSeccion').value;
  const filtroOP      = document.getElementById('filtroOP').value.trim().toLowerCase();
  const filtroCliente = document.getElementById('filtroCliente').value.trim().toLowerCase();

  let lista = ordenes.filter(op => {
    if (filtroSec !== 'Todas' && op.seccion !== filtroSec) return false;

    if (filtroOP) {
      const txtOp = (op.codigo || '').toLowerCase();
      if (!txtOp.includes(filtroOP)) return false;
    }

    if (filtroCliente) {
      const cli = (op.cliente || '').toLowerCase();
      if (!cli.includes(filtroCliente)) return false;
    }

    return true;
  });

  // Ordenar: fecha más cercana primero, sin fecha al final; luego por código de OP
  lista.sort((a, b) => {
    const fa = a.fechaEntrega || '';
    const fb = b.fechaEntrega || '';

    if (!fa && fb) return 1;
    if (fa && !fb) return -1;

    if (fa && fb && fa !== fb) {
      return fa.localeCompare(fb); // YYYY-MM-DD
    }

    const ca = (a.codigo || '').toLowerCase();
    const cb = (b.codigo || '').toLowerCase();
    return ca.localeCompare(cb);
  });

  let seccionActual = null;

  lista.forEach(op => {
    if (op.seccion !== seccionActual) {
      seccionActual = op.seccion;
      const h = document.createElement('div');
      h.className = 'section-title';
      h.textContent = seccionActual || 'Sin sección';
      cont.appendChild(h);
    }

    const card = document.createElement('div');
    card.className = 'op-card';

    // Cálculo de días restantes
    const MS_DAY = 24 * 60 * 60 * 1000;
    let badgeHtml = '';
    if (op.fechaEntrega) {
      const hoy = new Date();
      const f   = new Date(op.fechaEntrega + 'T00:00:00');
      if (!isNaN(f)) {
        const diff = Math.floor((f - hoy) / MS_DAY); // días hasta la entrega
        if (diff <= 3) {
          const texto = diff <= 0 ? 'VENCIDA' : `EN ${diff} DÍAS`;
          badgeHtml = `<span class="due-badge due-red">${texto}</span>`;
        } else if (diff <= 5) {
          badgeHtml = `<span class="due-badge due-orange">EN ${diff} DÍAS</span>`;
        }
      }
    }

    card.innerHTML = `
      <div><strong>OP:</strong> ${op.codigo}</div>
      ${op.cliente ? `<div><strong>Cliente:</strong> ${op.cliente}</div>` : ""}
      ${op.mueble ? `<div><strong>Mueble:</strong> ${op.mueble}</div>` : ""}
      <div><strong>Fecha entrega:</strong> ${op.fechaEntrega || '-'}${badgeHtml ? ' ' + badgeHtml : ''}</div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
        <span class="tag-seccion">${op.seccion}</span>
        <button class="btn btn-secondary btn-small"
          onclick="event.stopPropagation(); abrirDesdeLista('${op.codigo}')">Editar</button>
      </div>
    `;
    cont.appendChild(card);
  });

  if (lista.length === 0) {
    cont.innerHTML = '<p>No hay órdenes.</p>';
  }
}

/* ===== ESCANEO / EDICIÓN ===== */
function abrirScannerManual() {
  document.getElementById('scannerSim').style.display = 'block';
  pararCamara();
  const input = document.getElementById('codigoInput');
  input.focus();
}

function abrirScannerCamara() {
  document.getElementById('scannerSim').style.display = 'block';
  iniciarCamara();
}

/* Iniciar / parar cámara con ZXing */
function iniciarCamara() {
  const cameraArea = document.getElementById('cameraArea');
  cameraArea.style.display = 'block';

  if (!codeReader) {
    codeReader = new ZXing.BrowserBarcodeReader();
  }

  codeReader.decodeFromVideoDevice(null, 'videoPreview', (result, err) => {
    if (result) {
      const codigo = result.getText();
      document.getElementById('codigoInput').value = codigo;
      pararCamara();
      simularEscaneo();
    }
    // errores de lectura se ignoran, la cámara sigue intentándolo
  }).catch(err => {
    console.error(err);
    alert('No se puede acceder a la cámara. Revisa permisos del navegador.');
    pararCamara();
  });
}

function pararCamara() {
  const cameraArea = document.getElementById('cameraArea');
  cameraArea.style.display = 'none';
  if (codeReader) {
    codeReader.reset();
  }
}

function abrirDesdeLista(codigo) {
  document.getElementById('scannerSim').style.display = 'block';
  document.getElementById('codigoInput').value = codigo;
  pararCamara();
  simularEscaneo();
}

function simularEscaneo() {
  const codigo = document.getElementById('codigoInput').value.trim();
  const res    = document.getElementById('resultado');
  const editor = document.getElementById('editorOP');

  if (!codigo) {
    res.textContent = 'Introduce un código válido';
    editor.style.display = 'none';
    return;
  }

  let op = ordenes.find(o => o.codigo === codigo);
  if (op) {
    alert(`La OP ${codigo} ya existe. Se abre para editar, no se crea un duplicado.`);
  } else {
    op = {
      codigo,
      cliente: '',
      mueble: '',
      seccion: 'Corte',
      fechaEntrega: '',
      historial: []
    };
    ordenes.push(op);
    saveOrdenes();
  }

  opActual = op;

  document.getElementById('opCodigo').textContent   = op.codigo;
  document.getElementById('clienteInput').value     = op.cliente || '';
  document.getElementById('muebleInput').value      = op.mueble || '';
  document.getElementById('seccionSelect').value    = op.seccion || 'Corte';
  document.getElementById('fechaEntrega').value     = op.fechaEntrega || '';

  res.textContent = `OP ${codigo} cargada.`;
  editor.style.display = 'block';
  pintarHistorial();
}

/* ===== GUARDAR / ELIMINAR ===== */
function guardarOP() {
  if (!opActual) return;

  const fecha = document.getElementById('fechaEntrega').value;
  if (!fecha) {
    alert('La fecha de entrega es obligatoria.');
    return;
  }

  const seccionAnterior = opActual.seccion;
  const muebleAnterior  = opActual.mueble || '';

  opActual.cliente      = document.getElementById('clienteInput').value.trim();
  opActual.mueble       = document.getElementById('muebleInput').value.trim();
  opActual.seccion      = document.getElementById('seccionSelect').value;
  opActual.fechaEntrega = fecha;

  const marcaTiempo = new Date().toLocaleString();
  const cambios = [];

  if (seccionAnterior !== opActual.seccion) {
    cambios.push(`Sección: ${seccionAnterior || 'Sin'} → ${opActual.seccion}`);
  }
  if (muebleAnterior !== opActual.mueble) {
    cambios.push(`Mueble: ${muebleAnterior || 'Sin'} → ${opActual.mueble || 'Sin'}`);
  }

  if (cambios.length > 0) {
    if (!Array.isArray(opActual.historial)) opActual.historial = [];
    opActual.historial.push(`${marcaTiempo} — ${cambios.join(' | ')}`);
  }

  saveOrdenes();
  renderOrdenes();
  pintarHistorial();

  document.getElementById('movimientoResultado').textContent =
    `OP ${opActual.codigo} guardada en sección ${opActual.seccion}.`;
}

function eliminarOP() {
  if (!opActual) return;
  const codigo = opActual.codigo;
  if (!confirm(`¿Eliminar la OP ${codigo}?`)) return;

  ordenes = ordenes.filter(o => o.codigo !== codigo);
  opActual = null;

  document.getElementById('editorOP').style.display = 'none';
  document.getElementById('resultado').textContent = `OP ${codigo} eliminada.`;
  document.getElementById('movimientoResultado').textContent = '';

  saveOrdenes();
  renderOrdenes();
}

/* ===== HISTORIAL ===== */
function pintarHistorial() {
  const ul = document.getElementById('historialOP');
  ul.innerHTML = '';

  if (!opActual || !Array.isArray(opActual.historial) || opActual.historial.length === 0) {
    ul.innerHTML = '<li>No hay movimientos registrados.</li>';
    return;
  }

  opActual.historial.slice().reverse().forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    ul.appendChild(li);
  });
}

function toggleHistorial() {
  const ul = document.getElementById('historialOP');
  if (ul.style.display === 'none' || ul.style.display === '') {
    ul.style.display = 'block';
  } else {
    ul.style.display = 'none';
  }
}

/* ===== SERVICE WORKER (PWA OFFLINE) ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .catch(err => console.log('Fallo al registrar SW', err));
  });
}

/* ===== INICIO ===== */
window.addEventListener('DOMContentLoaded', () => {
  loadOrdenes();
  renderOrdenes();
});
</script>

</body>
</html>
