


<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión OP - Oficina / Seccionadora / Pantógrafos / Bancos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Evitar cache en móviles -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- PWA -->
  <meta name="theme-color" content="#004b7c">
  <link rel="manifest" href="manifest.webmanifest">
  <!-- Iconos: cuando subas icon-192.png y icon-512.png se usarán aquí -->
  <link rel="icon" href="icon-192.png">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 0;
      font-family: system-ui, sans-serif;
      background: #f2f2f2;
      color: #333;
    }

    header {
      background: #004b7c;
      color: white;
      padding: 10px 16px;
    }

    main {
      padding: 10px 16px 40px;
      max-width: 1300px;
      margin: auto;
    }

    .panel {
      padding: 12px;
      background: white;
      border-radius: 6px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    h2,h4 { margin: 6px 0; }

    /* Formulario */
    form#form-op {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }

    label { font-size: .8rem; font-weight: 600; }
    input[type=text], input[type=date] {
      padding: 6px; border-radius: 4px;
      border: 1px solid #ccc; font-size: .9rem;
    }

    button {
      border: none; border-radius: 4px;
      padding: 7px 10px; cursor: pointer;
      font-size: .85rem;
    }
    .btn-principal { background: #0069d9; color: white; }
    .btn-secundario { background: #ddd; }
    .btn-peligro { background: #dc3545; color: white; }

    /* Tablero */
    .board-op {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 14px;
    }

    .columna-op {
      background: #fafafa;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
      min-height: 120px;
    }

    .lista-op { display: flex; flex-direction: column; gap: 6px; }

    .op-card {
      background: white;
      border: 1px solid #bbb;
      border-radius: 5px;
      padding: 8px;
      font-size: .85rem;
    }

    .op-card-header {
      display: flex; justify-content: space-between;
      font-weight: bold; margin-bottom: 4px;
    }

    .tag-urgencia {
      background: rgba(255,255,255,0.7);
      border: 1px solid #999;
      padding: 2px 6px;
      font-size: .7rem;
      border-radius: 999px;
    }

    .op-card-buttons {
      display: flex; flex-wrap: wrap; gap: 4px;
      margin-top: 6px;
    }

    .contador {
      text-align: right;
      margin-top: 6px;
      font-size: .8rem;
    }

    /* QR */
    #qr-reader {
      width: 100%;
      max-width: 380px;
      margin-top: 8px;
    }
    #qr-estado {
      font-size: .8rem;
      margin-top: 4px;
      color: #555;
    }
  </style>
</head>
<body>

<header><h1>Gestión OP · Oficina / Seccionadora / Pantógrafos / Bancos</h1></header>

<main>

  <!-- FORMULARIO -->
  <section class="panel">
    <h2>Crear o Actualizar OP</h2>
    <form id="form-op">
      <div>
        <label>OP *</label>
        <input type="text" id="op" required>
      </div>
      <div>
        <label>Mueble</label>
        <input type="text" id="descripcion">
      </div>
      <div>
        <label>Cliente</label>
        <input type="text" id="cliente">
      </div>
      <div>
        <label>Fecha Entrega *</label>
        <input type="date" id="fechaEntrega" required>
      </div>
      <div>
        <button class="btn-principal" type="submit">Guardar / Actualizar</button>
        <button type="button" class="btn-secundario" id="btn-limpiar-form">Limpiar</button>
      </div>
    </form>
  </section>

  <!-- ESCÁNER QR / CÓDIGO -->
  <section class="panel">
    <h2>Escanear OP con la cámara</h2>
    <p style="font-size:.85rem;">
      Pulsa <strong>Iniciar cámara</strong>, apunta al código (QR o código legible) de la OP
      y cuando lo lea, rellenará el campo <strong>OP</strong> automáticamente.
    </p>
    <button id="btn-toggle-qr" class="btn-secundario">Iniciar cámara</button>
    <div id="qr-estado"></div>
    <div id="qr-reader" style="display:none;"></div>
  </section>

  <!-- TABLERO -->
  <section class="panel">
    <h2>Estado de las OP</h2>

    <div class="board-op">

      <!-- OFICINA -->
      <div class="columna-op" data-seccion="Oficina">
        <h4>Oficina</h4>
        <div id="col-oficina" class="lista-op"></div>
        <div id="count-oficina" class="contador"></div>
      </div>

      <!-- SECCIONADORA -->
      <div class="columna-op" data-seccion="Seccionadora">
        <h4>Seccionadora</h4>
        <div id="col-seccionadora" class="lista-op"></div>
        <div id="count-seccionadora" class="contador"></div>
      </div>

      <!-- PANTÓGRAFOS -->
      <div class="columna-op" data-seccion="Pantografos">
        <h4>Pantógrafos</h4>
        <div id="col-pantografos" class="lista-op"></div>
        <div id="count-pantografos" class="contador"></div>
      </div>

      <!-- BANCOS -->
      <div class="columna-op" data-seccion="Bancos">
        <h4>Bancos</h4>
        <div id="col-bancos" class="lista-op"></div>
        <div id="count-bancos" class="contador"></div>
      </div>

    </div>
  </section>

</main>

<!-- Librería de escaneo QR -->
<script src="https://unpkg.com/html5-qrcode" defer></script>

<script>
/* ================================
   LOCAL STORAGE
================================ */
const STORAGE_KEY = "ops_produccion_v5";
let ops = [];

function cargarOps() {
  ops = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}

function guardarOps() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(ops));
}

/* ================================
   UTILIDADES
================================ */
function diasHasta(fecha) {
  const hoy = new Date();
  const f = new Date(fecha + "T00:00:00");
  return Math.round((f - hoy) / 86400000);
}

function colorPorUrgencia(fecha) {
  const d = diasHasta(fecha);
  if (isNaN(d)) return "#ffffff";
  if (d < 0) return "#ffcccc";
  if (d <= 2) return "#ffe0cc";
  if (d <= 7) return "#fff3cd";
  return "#d4edda";
}

function textoUrgencia(fecha) {
  const d = diasHasta(fecha);
  if (isNaN(d)) return "-";
  if (d < 0) return `Vencida ${Math.abs(d)}d`;
  if (d === 0) return "Hoy";
  if (d === 1) return "Mañana";
  return `En ${d}d`;
}

function siguienteOrden(seccion) {
  const lista = ops.filter(o => o.seccion === seccion);
  if (!lista.length) return 1;
  return Math.max(...lista.map(o => o.orden || 0)) + 1;
}

/* ================================
   CRUD
================================ */
function upsertOP(data) {
  let item = ops.find(o => o.op === data.op);

  if (!item) {
    ops.push({
      op: data.op,
      descripcion: data.descripcion || "",
      cliente: data.cliente || "",
      fechaEntrega: data.fechaEntrega,
      seccion: "Oficina",
      orden: siguienteOrden("Oficina")
    });
  } else {
    item.descripcion = data.descripcion;
    item.cliente = data.cliente;
    item.fechaEntrega = data.fechaEntrega;
  }

  guardarOps();
  render();
}

function borrarOP(cod) {
  if (!confirm("¿Borrar OP " + cod + "?")) return;
  ops = ops.filter(o => o.op !== cod);
  guardarOps();
  render();
}

function moverOP(cod, destino) {
  let item = ops.find(o => o.op === cod);
  if (!item) return;
  item.seccion = destino;
  item.orden = siguienteOrden(destino);
  guardarOps();
  render();
}

function subirOP(cod) {
  let op = ops.find(o => o.op === cod);
  if (!op) return;
  let lista = ops.filter(o => o.seccion === op.seccion).sort((a,b)=>a.orden-b.orden);
  let idx = lista.indexOf(op);
  if (idx <= 0) return;

  let arriba = lista[idx - 1];
  [op.orden, arriba.orden] = [arriba.orden, op.orden];
  guardarOps();
  render();
}

function bajarOP(cod) {
  let op = ops.find(o => o.op === cod);
  if (!op) return;
  let lista = ops.filter(o => o.seccion === op.seccion).sort((a,b)=>a.orden-b.orden);
  let idx = lista.indexOf(op);
  if (idx === lista.length - 1) return;

  let abajo = lista[idx + 1];
  [op.orden, abajo.orden] = [abajo.orden, op.orden];
  guardarOps();
  render();
}

function editarOP(cod) {
  let item = ops.find(o => o.op === cod);
  if (!item) return;

  let d = prompt("Descripción:", item.descripcion);
  if (d === null) return;

  let c = prompt("Cliente:", item.cliente);
  if (c === null) return;

  let f = prompt("Fecha entrega (YYYY-MM-DD):", item.fechaEntrega);
  if (!f) return alert("Fecha obligatoria");

  item.descripcion = d;
  item.cliente = c;
  item.fechaEntrega = f;

  guardarOps();
  render();
}

/* ================================
   BORRADO AUTOMÁTICO 15 DÍAS
================================ */
function limpiarAntiguas() {
  let hoy = new Date();
  let eliminar = ops.filter(o => {
    let f = new Date(o.fechaEntrega + "T00:00:00");
    return (hoy - f) / 86400000 > 15;
  });

  if (eliminar.length > 0) {
    if (confirm("Hay " + eliminar.length + " OP antiguas (+15 días). ¿Borrar?")) {
      let ids = new Set(eliminar.map(x => x.op));
      ops = ops.filter(o => !ids.has(o.op));
      guardarOps();
    }
  }
}

/* ================================
   RENDER TABLERO
================================ */
function botonesMovimientoHTML(op) {
  if (op.seccion === "Oficina")
    return `<button onclick="moverOP('${op.op}','Seccionadora')">▶ Seccionadora</button>`;

  if (op.seccion === "Seccionadora")
    return `
      <button onclick="moverOP('${op.op}','Oficina')">◀ Oficina</button>
      <button onclick="moverOP('${op.op}','Pantografos')">▶ Pantógrafos</button>
    `;

  if (op.seccion === "Pantografos")
    return `
      <button onclick="moverOP('${op.op}','Seccionadora')">◀ Seccionadora</button>
      <button onclick="moverOP('${op.op}','Bancos')">▶ Bancos</button>
    `;

  if (op.seccion === "Bancos")
    return `<button onclick="moverOP('${op.op}','Pantografos')">◀ Pantógrafos</button>`;

  return "";
}

function render() {
  const col = {
    Oficina: document.getElementById("col-oficina"),
    Seccionadora: document.getElementById("col-seccionadora"),
    Pantografos: document.getElementById("col-pantografos"),
    Bancos: document.getElementById("col-bancos")
  };

  const cnt = {
    Oficina: document.getElementById("count-oficina"),
    Seccionadora: document.getElementById("count-seccionadora"),
    Pantografos: document.getElementById("count-pantografos"),
    Bancos: document.getElementById("count-bancos")
  };

  Object.values(col).forEach(c => c.innerHTML = "");
  Object.values(cnt).forEach(c => c.innerHTML = "");

  const secciones = ["Oficina", "Seccionadora", "Pantografos", "Bancos"];

  secciones.forEach(sec => {
    let lista = ops
      .filter(o => o.seccion === sec)
      .sort((a,b)=> (a.orden || 0) - (b.orden || 0));

    cnt[sec].innerText = "Total: " + lista.length;

    lista.forEach(op => {
      let card = document.createElement("div");
      card.className = "op-card";
      card.style.background = colorPorUrgencia(op.fechaEntrega);

      card.innerHTML = `
        <div class="op-card-header">
          OP ${op.op}
          <span class="tag-urgencia">${textoUrgencia(op.fechaEntrega)}</span>
        </div>

        <div><strong>Mueble:</strong> ${op.descripcion || "-"}</div>
        <div><strong>Cliente:</strong> ${op.cliente || "-"}</div>
        <div><strong>Entrega:</strong> ${op.fechaEntrega || "-"}</div>

        <div class="op-card-buttons">
          <button onclick="subirOP('${op.op}')">▲</button>
          <button onclick="bajarOP('${op.op}')">▼</button>
          ${botonesMovimientoHTML(op)}
          <button onclick="editarOP('${op.op}')">Editar</button>
          <button class="btn-peligro" onclick="borrarOP('${op.op}')">Borrar</button>
        </div>
      `;

      col[sec].appendChild(card);
    });
  });
}

/* ================================
   FORMULARIO
================================ */
function initForm() {
  const f = document.getElementById("form-op");
  const inputOP = document.getElementById("op");

  f.addEventListener("submit", e => {
    e.preventDefault();

    let op = inputOP.value.trim();
    let descripcion = document.getElementById("descripcion").value.trim();
    let cliente = document.getElementById("cliente").value.trim();
    let fecha = document.getElementById("fechaEntrega").value;

    if (!op) return alert("OP requerida");
    if (!fecha) return alert("Fecha obligatoria");

    upsertOP({ op, descripcion, cliente, fechaEntrega: fecha });
    f.reset();
    inputOP.focus();
  });

  document
    .getElementById("btn-limpiar-form")
    .addEventListener("click", () => f.reset());
}

/* ================================
   ESCÁNER QR / CÁMARA
================================ */
let qrScanner = null;
let qrRunning = false;

function initQR() {
  const btn = document.getElementById("btn-toggle-qr");
  const estado = document.getElementById("qr-estado");
  const divReader = document.getElementById("qr-reader");
  const inputOP = document.getElementById("op");

  if (!btn || !divReader) return;

  btn.addEventListener("click", async () => {
    if (qrRunning) {
      // Parar
      if (qrScanner) {
        await qrScanner.stop().catch(()=>{});
        await qrScanner.clear().catch(()=>{});
      }
      qrRunning = false;
      divReader.style.display = "none";
      btn.textContent = "Iniciar cámara";
      estado.textContent = "";
      return;
    }

    // Iniciar
    try {
      if (!window.Html5Qrcode) {
        estado.textContent = "Cargando librería de cámara...";
        return;
      }

      divReader.style.display = "block";
      estado.textContent = "Abriendo cámara...";

      qrScanner = new Html5Qrcode("qr-reader");

      await qrScanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        (decodedText) => {
          // Cuando lee algo
          inputOP.value = decodedText.trim();
          estado.textContent = "Leído: " + decodedText;
        },
        (error) => {
          // errores de lectura continuos: no hacemos nada
        }
      );

      qrRunning = true;
      btn.textContent = "Parar cámara";
      estado.textContent = "Apunta al código de la OP.";
    } catch (err) {
      console.error(err);
      estado.textContent = "No se pudo acceder a la cámara.";
      divReader.style.display = "none";
      qrRunning = false;
    }
  });
}

/* ================================
   SERVICE WORKER (PWA)
================================ */
function initServiceWorker() {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(err => {
      console.log("SW error:", err);
    });
  }
}

/* ================================
   INICIO
================================ */
window.onload = () => {
  cargarOps();
  limpiarAntiguas();
  initForm();
  render();
  initQR();
  initServiceWorker();
};

// Global para onclick
window.moverOP = moverOP;
window.subirOP = subirOP;
window.bajarOP = bajarOP;
window.editarOP = editarOP;
window.borrarOP = borrarOP;
</script>

</body>
</html>
